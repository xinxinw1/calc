<html>

<head>
<title>Complex Math</title>
<meta http-equiv="content-type" content="text/html;charset=UTF-8">
<script type="text/javascript">
var funcmath = ["sqrt"];
var funcjs = ["sqrt"];

function math(expr){
  try {
    expr = new String(expr);
    var origExpr = expr; // used when displaying result
    
    clearLog();
    log("Input:", expr);
    
    //// changes all - to +- when there is a number before it
    expr = expr.replace(/([i0-9)])-/g,"$1+-");
    log("\"-\" -> \"+-\" :", expr);
    
    //// changes all numbers to ‘a,b’ (ex. -6i -> ‘0,-6’)
    expr = expr.replace(/(-?[0-9]+)(?!i|[0-9])/g, "‘$1,0’"); // real numbers
    expr = expr.replace(/(-?[0-9]+)i/g, "‘0,$1’"); // imaginary numbers
    expr = expr.replace(/(-?)i/g, "‘0,$11’"); // "i" or "-i"
    expr = expr.replace(/-(?![0-9])/g, "‘-1,0’*"); // "-" (ex. "-(23)")
    log("a -> ‘a,0’ :", expr);
    
    //// process brackets
    var start, end, substr, argarr, funcarr, func, pos, result, jsfunc, run;
    while (expr.indexOf("(") != -1 && expr.indexOf(")") != -1){
      start = expr.search(/\([^(]*\)/); // last "(" before first ")"
      end = expr.indexOf(")") + 1;      // first ")"
      
      substr = expr.substring(start+1, end-1); // part between ()
      argarr = substr.split(/,(?=‘)/); // function arguments array
      argarr.calcAll(); // calc() all parts of array
      
      funcarr = getWordBefore(expr, start);
      func = funcarr[0]; // function name
      pos = funcarr[1];  // position of start of function name
      if (func == ""){
        if (argarr.length == 1)result = argarr[0];
        else throw "Syntax Error: Unexpected \",\"";
      } else {           // if there is a function name
        jsfunc = funcjs[funcmath.indexOf(func)]; // find the JS function
        if (jsfunc == undefined){
          throw "Syntax Error: Invalid Function \"" + func + "\"";
        }
        run = jsfunc + "(\"" + argarr.join("\",\"") + "\")";
        log("Function:", run);
        result = eval(run);
        log("Result:", result);
      }
      expr = expr.substring(0, pos) + result + expr.substring(end, expr.length);
      log("Remove Brackets:", expr);
    }
    
    //// catch missing brackets
    var match = expr.match(/[()]/);
    if (match == "(")throw "Syntax Error: Missing \")\"";
    if (match == ")")throw "Syntax Error: Missing \"(\"";
    
    //// perform last calculation
    expr = calc(expr);
    log("Calculations Finished:", expr);
    
    //// change ‘a,b’ to a+bi
    expr = expr.replace(/‘(-?[0-9.]+),(-?[0-9.]+)’/g, "$1+$2i");
    expr = expr.replace(/1i/g, "i");
    expr = expr.replace(/\+-/g, "-");
    expr = expr.replace(/(\+|-)0i/g, "");
    expr = expr.replace(/0\+/g, "");
    expr = expr.replace(/0-/g, "-");
    log("Finished:", expr);
    
    //// display result
    document.getElementById("results").innerHTML += origExpr + "<br>" + "= " + expr + "<br><br>";
    return (expr);
  } catch (err){ // catch "throw ..."
    log("", err);
  }
}
//// changes all - to +- when there is a number before it
    /*for (var i = 0; i < expr.length; i++){
      if (expr.charAt(i) == "-"){
        if ((/[i0-9)]/).test(expr.charAt(i-1))){
          expr = expr.substring(0, i) + "+" + expr.substring(i, expr.length);
        }
      }
    }*/

//// changes all numbers to ‘a,b’ (ex. -6i -> ‘0,-6’)
/*var start, end, changed, mid;
    changed = true;
    while (changed == true){
      changed = false; // if nothing has been changed, stop while loop
      for (var i = 0; i < expr.length; i++){
        if (expr.charAt(i) == "‘"){ // ignore anything between "‘" and "’"
          for (i = i; i < expr.length; i++){
            if (expr.charAt(i) == "’")break;
          }
          if (i == expr.length)break;
        }
        if (!isNaN(Number(expr.charAt(i))) || expr.charAt(i) == "-" || expr.charAt(i) == "i"){ // if character is a number or "-"
          start = i;            // find length of the number
          for (i = i+1; i <= expr.length; i++){
            if (i == expr.length || (isNaN(Number(expr.charAt(i))) && expr.charAt(i) != "." && expr.charAt(i) != "i")){
              end = i;
              if (expr.charAt(end-1) == "i"){// replace number with proper ‘a,b’
                if (expr.substring(start, end-1) == "")mid = "‘0,1’";
                else mid = "‘0," + expr.substring(start, end-1) + "’";
              } else if (expr.substring(start, end) == "-"){
                mid = "‘-1,0’*";
              } else {
                mid = "‘" + expr.substring(start, end) + ",0’";
              }
              expr = expr.substring(0, start) + mid + expr.substring(end, expr.length);
              break;
            }
          }
          changed = true;
          break;
        }
      }
    }
    expr = expr.replace(/‘-,0’/g, "‘-1,0’");// if there is something like "-(2)"
    expr = expr.replace(/‘0,-’/g, "‘0,-1’");*/ // the previous loop will make it
                                             // into "‘-,0’*(‘2,0’)"

//// change ‘a,b’ to a+bi
/*var a, b, c, d;
    var exparr;
    expr = expr.replace(/[‘’]/g, "");
    exparr = expr.split(",");
    
    var result = new String ();
    var test1 = (/^-?0$/).test(exparr[0]);
    var test2 = (/^-?0$/).test(exparr[1]);
    
    if (test1 && test2)result = "0";
    if (!test1 && test2)result = exparr[0];
    if (test1 && !test2)result = exparr[1] + "i";
    if (!test1 && !test2)result = exparr[0] + "+" + exparr[1] + "i";
    
    result = result.replace(/\+-/g, "-");
    result = result.replace(/1i/g, "i");*/
    
//// process brackets
    /*var start, end, argarr, substr, pos, result, func;
    while (expr.indexOf("(") != -1 && expr.indexOf(")") != -1){// while brackets
      for (var i = 0; i < expr.length; i++){                        // exist
        if (expr.charAt(i) == "(")pos = i; // go through expr and find last
        else if (expr.charAt(i) == ")"){   // opening bracket before a closing
          argarr = [];                     // bracket
          substr = expr.substring(pos+1, i);//substr holds part between brackets
          start = 0;
          for (var b = 0; b <= substr.length; b++){//put arguments of functions,
            if (substr.charAt(b) == "‘"){          // calculated, into argarray
              for (b = b; b < substr.length; b++){ // (ex. (‘-1,0’,‘5,0’)
                if (substr.charAt(b) == "’")break; // -> ["‘-1,0’","‘5,0’"])
              }
              if (b == substr.length)break;
            } // ignore "," between "‘" and "’"
            if (substr.charAt(b) == "," || b == substr.length){
              end = b;
              argarr.push(calc(substr.substring(start,end)));
              start = end+1;
            }
          }
          func = getWordBefore(expr, pos);
          if (func == ""){               // if there is no function name
            if (argarr.length == 1)result = argarr[0]; // remove the brackets
            else throw "Syntax Error: Unexpected \",\"";
          } else {                       // if there is a function name
            var e;
            for (e in functions){        // find the JS function and run it
              if (func == functions[e][0]){
                result = eval(functions[e][1] + "(\"" + argarr.join("\",\"") + "\")");
                break;
              }
            }
          }
          expr = expr.substring(0, pos) + result + expr.substring(i+1, expr.length);
          break;
        }
      }
      pos = false;
      log("Rem brackets:", expr);
    }*/

function calc(expr){ // calculate expr without brackets
  var before, after, result;
  expr = new String(expr);
  log("Start Calc:", expr);
  
  //// calculate "^"
  while (expr.indexOf("^") != -1){
    before = getNumBefore(expr, expr.indexOf("^"));
    after = getNumAfter(expr, expr.indexOf("^"));
    result = pow(before, after);
    expr = expr.replace(before + "^" + after, result); // replace is okay
    log("^ :", expr);             // because it only replaces the first one
  }
  
  //// calculate "*" and "/"
  var poss = [];
  poss[0] = 'expr.indexOf("*") == -1 && expr.indexOf("/") != -1';
  poss[1] = 'expr.indexOf("*") != -1 && expr.indexOf("/") == -1';
  poss[2] = 'expr.indexOf("*") != -1 && expr.indexOf("/") != -1';
  
  var mins = [];
  mins[0] = 'expr.indexOf("/")';
  mins[1] = 'expr.indexOf("*")';
  mins[2] = 'Math.min(expr.indexOf("*"), expr.indexOf("/"))';
  
  var signs = [];
  signs[0] = '"/"';
  signs[1] = '"*"';
  signs[2] = '(min == expr.indexOf("*"))?"*":"/"';
  
  var funcs = [];
  funcs[0] = '"div"';
  funcs[1] = '"mult"';
  funcs[2] = '(min == expr.indexOf("*"))?"mult":"div"';
  
  var min, sign, func, d;
  while (expr.indexOf("*") != -1 || expr.indexOf("/") != -1){
    for (d in poss){  // determine whether to use "*" or "/"
      if (eval(poss[d])){
        min = eval(mins[d]);
        sign = eval(signs[d]);
        func = eval(funcs[d]);
        break;
      }
    }
    before = getNumBefore(expr, min);
    after = getNumAfter(expr, min);
    result = eval(func + "(\"" + before + "\",\"" + after + "\")");
    expr = expr.replace(before + sign + after, result);
    log("* and / :", expr);
  }
  
  //// calculate "+"
  while (expr.indexOf("+") != -1){ // "+" has lowest priority
    before = getNumBefore(expr, expr.indexOf("+"));
    after = getNumAfter(expr, expr.indexOf("+"));
    result = add(before, after);
    expr = expr.replace(before + "+" + after, result);
    log("+ :", expr);
  }
  
  return (expr);
}

function getWordBefore(expr, pos){ // finds function name
  expr = new String(expr);
  for (var a = pos-1; a >= 0; a--){
    if (!(/[a-zA-Z0-9_]/).test(expr.charAt(a))){
      return ([expr.substring(a+1, pos), a+1]);
    }
  }
  return ([expr.substring(0, pos), 0]);
}

function getNumBefore(expr, pos){ // gets "3" from "3+4"
  expr = new String(expr);
  if (expr.charAt(pos-1) != "’"){ // error if "3**4"
    throw "Syntax Error: No number before \"" + expr.charAt(pos) + "\"";
  }
  for (var a = pos-1; a >= 0; a--){
    if (expr.charAt(a) == "‘"){
      return (expr.substring(a, pos));
      //return (a);
    }
  }
  throw "Syntax Error: No number before \"" + expr.charAt(pos) + "\"";
  //return (0);
}
function getNumAfter(expr, pos){ // gets "4" from "3+4"
  expr = new String(expr);
  if (expr.charAt(pos+1) != "‘"){ // error if "3**4"
    throw "Syntax Error: No number after \"" + expr.charAt(pos) + "\"";
  }
  for (var a = pos+1; a < expr.length; a++){
    if (expr.charAt(a) == "’"){
      return (expr.substring(pos+1, a+1));
      //return (a+1);
    }
  }
  throw "Syntax Error: No number after \"" + expr.charAt(pos) + "\"";
  //return (expr.length);
}

function clearLog(){
  var debug = document.getElementById("debug");
  debug.innerHTML = "";
}

function log(descr, data){ // write to log
  var debug = document.getElementById("debug");
  var write = "";
  
  write += "<tr>";
  write += "<td style=\"text-align: right;\">";
  write += descr;
  write += "</td>";
  write += "<td>";
  write += data;
  write += "</td>";
  write += "</tr>";
  
  debug.innerHTML += write;
}

function openNum(expr){
  expr = expr.replace(/[‘’]/g, "");
  var exprarr = expr.split(",");
  
  return (exprarr);
}

function closeNum(exprarr){
  var expr = "‘" + exprarr.join(",") + "’";
  
  return (expr);
}

Array.prototype.num = function (){ // makes all values of array into numbers
  for (var c = 0; c < this.length; c++){
    this[c] = Number(this[c]);
  }
}

Array.prototype.calcAll = function (){ // makes all values of array into numbers
  for (var c = 0; c < this.length; c++){
    this[c] = calc(this[c]);
  }
}


// Math Functions

function add(before, after){
  var a, b, c, d;
  var befarr, aftarr, resarr, result;
  befarr = openNum(before);
  befarr.num();
  a = befarr[0]; b = befarr[1];
  
  aftarr = openNum(after);
  aftarr.num();
  c = aftarr[0]; d = aftarr[1];
  
  resarr = [];
  resarr[0] = a + c;
  resarr[1] = b + d;
  
  result = closeNum(resarr);
  
  return (result);
}

function mult(before, after){
  var a, b, c, d;
  var befarr, aftarr, resarr, result;
  befarr = openNum(before);
  befarr.num();
  a = befarr[0]; b = befarr[1];
  
  aftarr = openNum(after);
  aftarr.num();
  c = aftarr[0]; d = aftarr[1];
  
  resarr = [];
  resarr[0] = a*c - b*d;
  resarr[1] = a*d + b*c;
  
  result = closeNum(resarr);
  
  return (result);
}

function div(before, after){
  var a, b, c, d;
  var befarr, aftarr, resarr, result;
  befarr = openNum(before);
  befarr.num();
  a = befarr[0]; b = befarr[1];
  
  aftarr = openNum(after);
  aftarr.num();
  c = aftarr[0]; d = aftarr[1];
  
  resarr = [];
  resarr[0] = (a*c + b*d)/(Math.pow(c, 2) + Math.pow(d, 2));
  resarr[1] = (b*c - a*d)/(Math.pow(c, 2) + Math.pow(d, 2));
  
  result = closeNum(resarr);
  
  return (result);
}

function pow(before, after){
  throw "Error: Pow doesn't exist yet";
}

function sqrt(expr){
  return ("‘1,0’");
}
//math(prompt("Math","5-i"));
//alert(getNumAfter("23.3435+2343.3435-345", 17));
</script>

<style type="text/css">
* {margin: 0; padding: 0; border: 0;}

table {border-collapse: collapse; width: 100%;}
td {vertical-align: top;}

td, th {border: 1px solid #000; padding: 5px; text-align: left;}

input, textarea, select {border: 1px solid #000; background-color: #ABE7B1; width: 100%; font: 12px Verdana, sans-serif;}
input[type="text"], textarea {padding: 1px;}
input[type="submit"], input[type="reset"], input[type="button"] {padding: 0 13px; background-color: #1BA72A; color: #FFF; width: auto;}
textarea {height: 500px;}

</style>
</head>

<body>

<form onsubmit="math(this.a.value); return false;">
  <input type="text" name="a" value="-(53*3-2/(4i))+((34+53i)/(23-34i))*(-i)">
</form>

<table>
  <tr>
    <td id="results"></td>
    <td style="padding: 0;">
      <table><tbody id="debug">
        <tr>
          <td style="text-align: right;"></td>
          <td></td>
        </tr>
      </tbody></table>
    </td>
  </tr>
</table>
</body>

</html>
