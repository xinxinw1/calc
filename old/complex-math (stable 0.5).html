<html>

<head>
<title>Complex Math</title>
<meta http-equiv="content-type" content="text/html;charset=UTF-8">
<script type="text/javascript">
var variables = new Array();


function math(expr){
  try {
    expr = new String(expr);
    var origExpr = expr; // used when displaying result
    
    clearLog();
    log("Input:", expr);
    
    //// check if set variables ("x=132")
    var vararr, varname, varpos, varexpr, illnames;
    var equpos = expr.indexOf("=");
    if (equpos != -1){
      vararr = getWordBefore(expr, equpos);
      varname = vararr[0]; varpos = vararr[1];
      
      if (varpos != 0)throw "Syntax Error: Invalid Variable Name \"" + expr.substring(0, equpos) + "\"";
      
      if (varname.match(/^(i|pi|e)$/))throw "Syntax Error: Illegal Variable Name \"" + varname.match(/^(i|pi|e)$/) + "\"";
      
      illnames = eval("/^(" + funcmath.join("|") + ")$/");
      if (varname.match(illnames))throw "Syntax Error: Variable Name \"" + varname.match(illnames) + "\" Conflicts With Function Name";
      
      expr = expr.substring(equpos+1, expr.length);
      varexpr = expr;
    }
    
    //// replace variables with their values
    var i, varregex;
    for (i in variables){
      varregex = eval("/\\b" + variables[i][0] + "\\b/g");
      if (varregex.test(expr)){
        expr = expr.replace(varregex, "(" + variables[i][1] + ")");
        log("Variable " + variables[i][0] + ":", expr);
      }
    }
    
    //// changes all - to +- when there is a number before it
    expr = expr.replace(/([i0-9)])-/g, "$1+-");
    log("\"-\" -> \"+-\" :", expr);
    
    //// changes all numbers to ‘a,b’ (ex. -6i -> ‘0,-6’)
    expr = expr.replace(/(-?[0-9]+)(?!i|[0-9])/g, "‘$1,0’"); // real numbers
    expr = expr.replace(/(-?[0-9]+)i/g, "‘0,$1’"); // imaginary numbers
    expr = expr.replace(/(-?)i/g, "‘0,$11’"); // "i" or "-i"
    expr = expr.replace(/-(?![0-9])/g, "‘-1,0’*"); // "-" (ex. "-(23)")
    log("a -> ‘a,0’ :", expr);
    
    //// process brackets
    var start, end, substr, argarr, funcarr, func, pos, result, jsfunc, run;
    while (expr.indexOf("(") != -1 && expr.indexOf(")") != -1){
      start = expr.search(/\([^(]*\)/); // last "(" before first ")"
      end = expr.indexOf(")") + 1;      // first ")"
      
      substr = expr.substring(start+1, end-1); // part between ()
      argarr = substr.split(/,(?=‘)/); // function arguments array
      argarr.calcAll(); // calc() all parts of array
      
      funcarr = getWordBefore(expr, start);
      func = funcarr[0]; // function name
      pos = funcarr[1];  // position of start of function name
      if (func == ""){
        if (argarr.length == 1)result = argarr[0];
        else throw "Syntax Error: Unexpected \",\"";
      } else {           // if there is a function name
        jsfunc = funcjs[funcmath.indexOf(func)]; // find the JS function
        if (jsfunc == undefined){
          throw "Syntax Error: Invalid Function \"" + func + "\"";
        }
        run = jsfunc + "(\"" + argarr.join("\",\"") + "\")";
        log("Function:", run);
        result = eval(run);
        log("Result:", result);
      }
      expr = expr.substring(0, pos) + result + expr.substring(end, expr.length);
      log("Remove Brackets:", expr);
    }
    
    //// catch missing brackets
    var match = expr.match(/[()]/);
    if (match == "(")throw "Syntax Error: Missing \")\"";
    if (match == ")")throw "Syntax Error: Missing \"(\"";
    
    //// perform last calculation
    expr = calc(expr);
    log("Calculations Finished:", expr);
    
    //// change ‘a,b’ to a+bi
    expr = expr.replace(/‘(-?[0-9.]+),(-?[0-9.]+)’/g, "$1+$2i");
    expr = expr.replace(/1i/g, "i");
    expr = expr.replace(/\+-/g, "-");
    expr = expr.replace(/(\+|-)0i/g, "");
    expr = expr.replace(/0\+/g, "");
    expr = expr.replace(/0-/g, "-");
    log("Finished:", expr);
    
    //// set variables if there is x=
    if (varname != undefined){
      var pastvarpos = indexOf2(varname, variables, 0); // remove old variable
      if (pastvarpos != -1){
        variables.splice(pastvarpos, 1);
      }
      variables.unshift([varname, varexpr, expr]);
      log("Set Variable " + varname + ":", varexpr);
    }
    
    //// display result
    document.getElementById("results").innerHTML += origExpr + "<br>" + "= " + expr + "<br><br>";
    return (expr);
  } catch (err){ // catch "throw ..."
    log("", err);
  }
}

function calc(expr){ // calculate expr without brackets
  var before, after, result;
  expr = new String(expr);
  log("Start Calc:", expr);
  
  //// calculate "^"
  while (expr.indexOf("^") != -1)expr = calcChar(expr, "^", "pow");
  
  //// calculate "*" and "/"
  var sign, func;
  while (expr.indexOf("*") != -1 || expr.indexOf("/") != -1){
    sign = new String(expr.match(/[*\/]/));
    func = (sign == "*")?"mult":"div";
    
    expr = calcChar(expr, sign, func);
  }
  
  //// calculate "+"
  while (expr.indexOf("+") != -1)expr = calcChar(expr, "+", "add");
  
  return (expr);
}

function calcChar(expr, sign, func){
  var before, after, result;
  before = getNumBefore(expr, sign);
  after = getNumAfter(expr, sign);
  result = eval(func + "(\"" + before + "\",\"" + after + "\")");
  expr = expr.replace(before + sign + after, result); // replace is okay
  log(sign + " :", expr);           // because it only replaces the first one
  return (expr);
}

////// Get Words or Numbers

function getWordBefore(expr, pos){ // finds function name
  expr = new String(expr);
  for (var i = pos-1; i >= 0; i--){
    if (!(/[a-zA-Z0-9_]/).test(expr.charAt(i))){
      return ([expr.substring(i+1, pos), i+1]);
    }
  }
  return ([expr.substring(0, pos), 0]);
}

function getNumBefore(expr, ch){ // gets "3" from "3+4"
  expr = new String(expr);
  ch = "\\" + ch;
  expr = new String(expr.match(eval("/‘[^’]*’(?=" + ch + ")/")));
  if (expr == "null")throw "Syntax Error: No number before \"" + ch + "\"";
  return (expr);
}

function getNumAfter(expr, ch){ // gets "4" from "3+4"
  expr = new String(expr);
  ch = "\\" + ch;
  expr = new String(expr.match(eval("/" + ch + "‘[^’]*’/")));
  if (expr == "null")throw "Syntax Error: No number before \"" + ch + "\"";
  expr = expr.substring(1, expr.length); // remove ch
  return (expr);
}

////// Log Functions

function clearLog(){
  var debug = document.getElementById("debug");
  debug.innerHTML = "";
}

function log(descr, data){ // write to log
  var debug = document.getElementById("debug");
  var write = "";
  
  write += "<tr>";
  write += "<td style=\"text-align: right;\">";
  write += descr;
  write += "</td>";
  write += "<td>";
  write += data;
  write += "</td>";
  write += "</tr>";
  
  debug.innerHTML += write;
}

////// ‘a,b’ Functions

function openNum(expr){
  expr = expr.replace(/[‘’]/g, "");
  var exprarr = expr.split(",");
  
  return (exprarr);
}

function closeNum(exprarr){
  var expr = "‘" + exprarr.join(",") + "’";
  
  return (expr);
}

////// Array Prototypes

Array.prototype.num = function (){ // makes all values of array into numbers
  for (var i = 0; i < this.length; i++){
    this[i] = Number(this[i]);
  }
}

Array.prototype.calcAll = function (){ // makes all values of array into numbers
  for (var i = 0; i < this.length; i++){
    this[i] = calc(this[i]);
  }
}

////// Array Functions

function indexOf2(data, arr, index){ // gets indexOf data in arr[i][index]
  var i;
  for (i in arr){
    if (arr[i][index] == data)return i;
  }
}

////// Math Functions

var funcmath = ["sqrt"];
var funcjs = ["sqrt"];

function add(before, after){
  var a, b, c, d;
  var befarr, aftarr, resarr, result;
  befarr = openNum(before);
  befarr.num();
  a = befarr[0]; b = befarr[1];
  
  aftarr = openNum(after);
  aftarr.num();
  c = aftarr[0]; d = aftarr[1];
  
  resarr = [];
  resarr[0] = a + c;
  resarr[1] = b + d;
  
  result = closeNum(resarr);
  
  return (result);
}

function mult(before, after){
  var a, b, c, d;
  var befarr, aftarr, resarr, result;
  befarr = openNum(before);
  befarr.num();
  a = befarr[0]; b = befarr[1];
  
  aftarr = openNum(after);
  aftarr.num();
  c = aftarr[0]; d = aftarr[1];
  
  resarr = [];
  resarr[0] = a*c - b*d;
  resarr[1] = a*d + b*c;
  
  result = closeNum(resarr);
  
  return (result);
}

function div(before, after){
  var a, b, c, d;
  var befarr, aftarr, resarr, result;
  befarr = openNum(before);
  befarr.num();
  a = befarr[0]; b = befarr[1];
  
  aftarr = openNum(after);
  aftarr.num();
  c = aftarr[0]; d = aftarr[1];
  
  resarr = [];
  resarr[0] = (a*c + b*d)/(Math.pow(c, 2) + Math.pow(d, 2));
  resarr[1] = (b*c - a*d)/(Math.pow(c, 2) + Math.pow(d, 2));
  
  result = closeNum(resarr);
  
  return (result);
}

function pow(before, after){
  throw "Error: Pow doesn't exist yet";
}

function sqrt(expr){
  throw "Error: sqrt doesn't exist yet";
}
</script>

<style type="text/css">
* {margin: 0; padding: 0; border: 0;}

table {border-collapse: collapse; width: 100%;}
td {vertical-align: top;}

td, th {border: 1px solid #000; padding: 5px; text-align: left;}

input, textarea, select {border: 1px solid #000; background-color: #ABE7B1; width: 100%; font: 12px Verdana, sans-serif;}
input[type="text"], textarea {padding: 1px;}
input[type="submit"], input[type="reset"], input[type="button"] {padding: 0 13px; background-color: #1BA72A; color: #FFF; width: auto;}
textarea {height: 500px;}

</style>
</head>

<body>

<form onsubmit="math(this.a.value); return false;">
  <input type="text" name="a" value="-(53*3-2/(4i))+((34+53i)/(23-34i))*(-i)">
</form>

<table>
  <tr>
    <td id="results"></td>
    <td style="padding: 0;">
      <table><tbody id="debug">
        <tr>
          <td style="text-align: right;"></td>
          <td></td>
        </tr>
      </tbody></table>
    </td>
  </tr>
</table>
</body>

</html>
